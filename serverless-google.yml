service: covid-vaccine-finder

frameworkVersion: "2"

useDotenv: true

provider:
  name: google
  runtime: nodejs12
  region: us-central1
  project: vaccine-304605
  credentials: ~/.gcloud/vaccine-304605-464fd4f14b90.json
  memorySize: 256
  timeout: 300s
  environment:
    DB_ENDPOINT: "${env:DB_ENDPOINT}"
    DB_KEY: "${env:DB_KEY}"
    GH_TOKEN: "${env:GH_TOKEN}"
    CACHE_DIR: /tmp/cache
  # os: windows  # windows is default, linux is available
  # prefix: "sample"  # prefix of generated resource name
  # subscriptionId: A356AC8C-E310-44F4-BF85-C7F29044AF99
  # stage: dev
  # type: premium  # premium azure functions

plugins:
  - serverless-google-cloudfunctions
    # - serverless-offline

# needs more granular excluding in production as only the serverless provider npm
# package should be excluded (and not the whole node_modules directory)
package:
  exclude:
    - node_modules/**
    - .gitignore
    - .git/**
    - .env
    - _site/**

functions:
  refreshAlbertsons:
    handler: refreshAlbertsons
    maxInstances: 1
    events:
      - event:
          eventType: providers/cloud.pubsub/eventTypes/topic.publish
          resource: 'projects/${self:provider.project}/topics/refreshAlbertsonsTopic'
  refreshWebsite:
    handler: refreshWebsite
    maxInstances: 1
    events:
      - event:
          eventType: providers/cloud.pubsub/eventTypes/topic.publish
          resource: 'projects/${self:provider.project}/topics/refreshWebsiteTopic'

resources:
  resources:
    - type: pubsub.v1.topic
      name: refreshAlbertsonsTopic
      properties:
        topic: refreshAlbertsonsTopic
    - type: gcp-types/cloudscheduler-v1:projects.locations.jobs
      name: refreshAlbertsonsJob
      properties:
        parent: projects/${self:provider.project}/locations/${self:provider.region} # not described in API spec but required
        name: refreshAlbertsonsJob
        description: "Produce some foo data"
        schedule: "*/2 * * * *"
        timeZone: "America/Denver"
        pubsubTarget:
          topicName: projects/${self:provider.project}/topics/refreshAlbertsonsTopic
          data: aGVsbG8hCg== # base64 encoded "hello!" that will be passed as PubSub message payload

    - type: pubsub.v1.topic
      name: refreshWebsiteTopic
      properties:
        topic: refreshWebsiteTopic
    - type: gcp-types/cloudscheduler-v1:projects.locations.jobs
      name: refreshWebsiteJob
      properties:
        parent: projects/${self:provider.project}/locations/${self:provider.region} # not described in API spec but required
        name: refreshWebsiteJob
        description: "Produce some foo data"
        schedule: "*/2 * * * *"
        timeZone: "America/Denver"
        pubsubTarget:
          topicName: projects/${self:provider.project}/topics/refreshWebsiteTopic
          data: aGVsbG8hCg== # base64 encoded "hello!" that will be passed as PubSub message payload
